# CDN容灾方案
当CDN资源加载失败时，有一套成熟的容灾方案来保证页面不“白屏”至关重要。其核心在于**准备好后备计划，并确保在CDN不可用时能平滑切换**。

| 方案维度 | 具体策略 | 关键实现方式 |
| :--- | :--- | :--- |
| **资源加载层面** | 多CDN域名轮询 | 用多个CDN域名存放资源，一个失败尝试下一个 |
| | 动态检测与重试 | 通过`onerror`和`onload`事件检测失败并重试 |
| **缓存策略层面** | 浏览器本地缓存 | 失败时从`localStorage`、`sessionStorage`或`IndexedDB`读取 |
| | Service Worker缓存 | 拦截请求，无网络时返回缓存版本 |
| **部署与监控** | 自动化部署与监控 | CI/CD流程集成；监控CDN可用性、资源加载成功率 |

### 🔧 资源加载层面的容灾

1.  **多CDN域名与智能重试**
    这是最直接的防线。
    不要将所有希望寄托在一个CDN域名上。
    可以**同时使用多个CDN服务商，或者为资源配置多个子域名**。
    在前端代码中，当一个CDN的资源加载失败（通过监听`<script>`或`<link>`标签的`onerror`事件），就动态替换资源地址为备用的CDN域名再次尝试加载。
    这个过程可以封装成通用的资源加载函数。

2.  **动态检测与加载**
    对于非核心的脚本或样式，可以采用动态加载的方式。通过JavaScript动态创建`<script>`或`<link>`标签，并监听其`onload`和`onerror`事件。这样不仅能控制加载时机，也更容易实现失败后的重试或降级逻辑。

### 💾 利用浏览器缓存做防线

1.  **本地存储作为后备**
    对于一些关键的初始数据或配置，可以在用户首次成功访问时，将其存储在浏览器的**`localStorage`、`sessionStorage`或`IndexedDB`**中。当CDN完全不可用导致页面资源无法加载时，可以尝试从本地存储中读取并初始化关键数据，确保页面核心框架和内容能够展示。

2.  **Service Worker 充当保险**
    Service Worker是一个更强大的离线缓存工具。
    它可以拦截页面的网络请求，能够完全控制响应行为。可以**在Service Worker的安装阶段预缓存关键静态资源**（如App Shell）。这样，即使用户下次访问时网络完全断开，或者CDN挂掉，Service Worker也能直接返回缓存的资源，保证页面基本功能和样式的正常运作。

### 🛠️ 部署与监控保障

1.  **自动化部署与版本管理**
    将静态资源上传到多个CDN的过程应集成到**CI/CD（持续集成/持续部署）流程**中，通过自动化脚本完成，避免手动操作出错。同时，为资源文件添加**版本号或哈希值**是非常重要的策略。这样，一旦文件内容变化，文件名就会改变，能强制浏览器下载最新版本，避免因缓存旧文件导致的异常。

2.  **完备的监控与告警**
    光有方案不够，还需要知道它是否生效。需要建立前端监控体系，重点关注**CDN的可用性、资源加载的错误率以及用户的白屏率**。当监控到大量资源加载错误或CDN节点异常时，告警系统需要能及时通知到运维或开发人员，以便快速介入，排查是CDN问题还是发布流程问题。

### 🔄 容灾方案的实施流程

一个相对完整的容灾流程可以这样设计：

1.  **加载资源**：页面尝试从主CDN域名加载静态资源。
2.  **检测失败**：通过`onerror`事件或`catch`块捕获加载失败。
3.  **首次重试**：立即切换到备用的CDN域名重新加载。
4.  **再次失败**：如果重试后依然失败，尝试从浏览器的本地缓存（如`localStorage`、`IndexedDB`）中读取资源的备份版本。
5.  **终极降级**：如果本地也没有缓存（例如新用户），则使用内置在页面主包（通常和页面HTML一起加载）的**最简降级代码/数据**，或者展示友好的错误提示，告知用户当前网络状况不佳。

### 💎 总结

前端CDN容灾的核心思想是：**不把鸡蛋放在一个篮子里，并为最坏的情况做好准备**。通过组合使用**多CDN域名、浏览器缓存和Service Worker**，可以构建起从资源加载到本地缓存的多道防线。再辅以**自动化的部署和监控**，就能在CDN出现问题时，最大程度地保障用户体验，避免灾难性的白屏。

