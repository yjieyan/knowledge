# 实现扫码登录

前端实现扫码登录功能，常见的流程是：

网页端生成二维码，用户用手机端（如微信）扫码，手机端完成授权后，网页端自动完成登录。以微信扫码登录为例，主要涉及以下步骤：

### 1）二维码生成与展示

网页端向后端请求一个唯一标识（如uuid），后端将该uuid与登录会话绑定，并生成带有该uuid的二维码。前端通过二维码生成库（如qrcode.js）将该uuid编码为二维码图片，展示在页面上。

### 2）轮询或长连接检测扫码状态

前端定时（如每秒）向后端轮询，查询该uuid对应的扫码状态。也可以用WebSocket实现实时推送。

### 3）手机端扫码与授权

用户用微信扫一扫功能扫描二维码，微信会识别二维码中的uuid和回调地址，拉起授权页面。用户同意授权后，微信服务器会回调你配置的后端接口，并带上临时code。

### 4）后端处理授权

后端收到微信回调后，用code换取access\_token和用户openid等信息，并将登录状态与uuid绑定，写入缓存（如Redis）。

### 5）前端检测到登录成功

前端轮询时发现uuid已被授权，获取到用户信息，完成登录流程，跳转到登录后的页面。

整个扫码登录流程核心在于“二维码唯一标识+轮询检测+第三方授权回调+登录态绑定”，安全性和用户体验都要兼顾。

## 扩展知识

### 1）微信扫码登录的两种方式

* 微信开放平台：适用于网站、App等第三方应用，需要公司资质，流程更标准，适合PC网页扫码登录。
* 微信公众平台：适用于公众号场景，通常是关注公众号后授权登录。

### 2）二维码内容与安全

二维码内容一般包含uuid和回调地址，不能直接暴露敏感信息。uuid要设置过期时间，防止被复用。

### 3）前端实现要点

* 二维码生成可用qrcode.js、qrious等库。
* 轮询可用setInterval+fetch，也可用WebSocket提升实时性。
* 登录成功后要清理定时器，避免多余请求。

### 4）后端实现要点

* uuid与用户信息的绑定建议用Redis等缓存，设置过期时间。
* 微信授权回调接口要校验code有效性，防止伪造请求。
* 登录态建议用JWT或session管理。

### 5）常见问题

* 二维码过期后要自动刷新。
* 防止二维码被截屏复用，可加设备指纹校验。
* 微信扫码登录需备案域名、配置回调地址，参考微信开放平台文档。

### 6）相关文档

* 微信开放平台扫码登录官方文档：<https://open.weixin.qq.com/>

* MDN二维码生成：
  <https://developer.mozilla.org/zh-CN/docs/Web/API/Canvas_API/Tutorial/Drawing_shapes>

### 7） React 核心代码示例

假设后端已提供获取 uuid、二维码图片和扫码状态的接口。

```jsx
// src/pages/ScanLogin.jsx
import React, { useEffect, useState, useRef } from "react";

function ScanLogin() {
  // ... existing code ...
  const [uuid, setUuid] = useState("");
  const [qrUrl, setQrUrl] = useState("");
  const [loginStatus, setLoginStatus] = useState("pending");
  const timerRef = useRef(null);

  // 获取二维码和uuid
  useEffect(() => {
    fetch("/api/get-uuid")
      .then(res => res.json())
      .then(data => {
        setUuid(data.uuid);
        setQrUrl(data.qrUrl); // 假设后端返回二维码图片地址
      });
  }, []);

  // 轮询扫码状态
  useEffect(() => {
    if (!uuid) return;
    timerRef.current = setInterval(() => {
      fetch(`/api/check-status?uuid=${uuid}`)
        .then(res => res.json())
        .then(data => {
          if (data.status === "success") {
            setLoginStatus("success");
            clearInterval(timerRef.current);
            // 跳转到首页或其他页面
            window.location.href = "/home";
          }
        });
    }, 1500);
    return () => clearInterval(timerRef.current);
  }, [uuid]);

  return (
    <div>
      <h2>微信扫码登录</h2>
      {qrUrl ? (
        <img src={qrUrl} alt="请使用微信扫码" />
      ) : (
        <p>正在生成二维码...</p>
      )}
      {loginStatus === "success" && <p>登录成功，正在跳转...</p>}
    </div>
  );
}

export default ScanLogin;
// ... existing code ...
```

1）二维码生成和uuid获取由后端负责，前端只需请求接口并展示二维码图片。

2）前端用 setInterval 轮询扫码状态，扫码成功后自动跳转。

3）实际项目中建议二维码失效后自动刷新，接口地址需根据实际后端调整。

4）如需更高实时性，可用 WebSocket 替代轮询。
