# å®ç°ä¸€ä¸ªç®€å•çš„è„šæ‰‹æ¶

---

## 1. è„šæ‰‹æ¶æ ¸å¿ƒæ¦‚å¿µ

**è„šæ‰‹æ¶æ˜¯ä»€ä¹ˆï¼Ÿ**
- ç”¨äºå¿«é€Ÿç”Ÿæˆé¡¹ç›®æ¨¡æ¿çš„å·¥å…·
- é€šè¿‡å‘½ä»¤è¡Œäº¤äº’å®šåˆ¶é¡¹ç›®é…ç½®
- è‡ªåŠ¨åˆ›å»ºé¡¹ç›®ç»“æ„å’Œæ–‡ä»¶

**å…¸å‹å·¥ä½œæµç¨‹ï¼š**
1. ç”¨æˆ·è¿è¡Œè„šæ‰‹æ¶å‘½ä»¤
2. è¯¢é—®ç”¨æˆ·é¡¹ç›®é…ç½®
3. æ ¹æ®é€‰æ‹©ä¸‹è½½æˆ–å¤åˆ¶æ¨¡æ¿
4. æ¸²æŸ“æ¨¡æ¿æ–‡ä»¶
5. æ‰§è¡Œå®‰è£…å‘½ä»¤

---

## 2. é¡¹ç›®ç»“æ„è®¾è®¡

é¦–å…ˆåˆ›å»ºé¡¹ç›®ç»“æ„ï¼š

```
my-cli/
â”œâ”€â”€ bin/
â”‚   â””â”€â”€ cli.js              # å‘½ä»¤è¡Œå…¥å£
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ index.js            # æ ¸å¿ƒé€»è¾‘
â”‚   â”œâ”€â”€ create.js           # åˆ›å»ºé¡¹ç›®é€»è¾‘
â”‚   â”œâ”€â”€ download.js         # æ¨¡æ¿ä¸‹è½½
â”‚   â””â”€â”€ generator.js        # æ–‡ä»¶ç”Ÿæˆ
â”œâ”€â”€ templates/              # æœ¬åœ°æ¨¡æ¿
â”‚   â”œâ”€â”€ vue-template/
â”‚   â”œâ”€â”€ react-template/
â”‚   â””â”€â”€ node-template/
â”œâ”€â”€ package.json
â””â”€â”€ README.md
```

---

## 3. æ ¸å¿ƒå®ç°

### 3.1 å‘½ä»¤è¡Œå…¥å£ (bin/cli.js)

```javascript
#!/usr/bin/env node

const { program } = require('commander');
const create = require('../lib/create');
const pkg = require('../package.json');

// å®šä¹‰å‘½ä»¤è¡Œ
program
  .version(pkg.version)
  .usage('<command> [options]');

// create å‘½ä»¤
program
  .command('create <project-name>')
  .description('åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®')
  .option('-t, --template <template>', 'é€‰æ‹©æ¨¡æ¿ (vue/react/node)')
  .option('-f, --force', 'å¼ºåˆ¶è¦†ç›–å·²å­˜åœ¨ç›®å½•')
  .action((name, options) => {
    create(name, options);
  });

// è§£æå‘½ä»¤è¡Œå‚æ•°
program.parse(process.argv);

// å¦‚æœæ²¡æœ‰è¾“å…¥å‘½ä»¤ï¼Œæ˜¾ç¤ºå¸®åŠ©
if (!process.argv.slice(2).length) {
  program.outputHelp();
}
```

**package.json é…ç½®ï¼š**
```json
{
  "name": "my-cli",
  "version": "1.0.0",
  "description": "ä¸€ä¸ªç®€å•çš„é¡¹ç›®è„šæ‰‹æ¶",
  "bin": {
    "my-cli": "./bin/cli.js"
  },
  "files": [
    "bin",
    "lib",
    "templates"
  ]
}
```

### 3.2 æ ¸å¿ƒåˆ›å»ºé€»è¾‘ (lib/create.js)

```javascript
const fs = require('fs');
const path = require('path');
const inquirer = require('inquirer');
const chalk = require('chalk');
const download = require('./download');
const generator = require('./generator');

async function create(projectName, options) {
  // è·å–å½“å‰å·¥ä½œç›®å½•
  const cwd = process.cwd();
  // é¡¹ç›®ç›®å½•
  const targetDir = path.join(cwd, projectName);

  // æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
  if (fs.existsSync(targetDir)) {
    if (options.force) {
      // å¼ºåˆ¶åˆ é™¤å·²å­˜åœ¨ç›®å½•
      fs.rmSync(targetDir, { recursive: true, force: true });
      console.log(chalk.yellow(`åˆ é™¤å·²å­˜åœ¨ç›®å½•: ${projectName}`));
    } else {
      // è¯¢é—®ç”¨æˆ·æ˜¯å¦è¦†ç›–
      const { action } = await inquirer.prompt([
        {
          name: 'action',
          type: 'list',
          message: `ç›®å½• ${chalk.cyan(projectName)} å·²å­˜åœ¨ï¼Œè¯·é€‰æ‹©æ“ä½œ:`,
          choices: [
            { name: 'è¦†ç›–', value: 'overwrite' },
            { name: 'å–æ¶ˆ', value: false }
          ]
        }
      ]);

      if (!action) {
        return;
      } else if (action === 'overwrite') {
        console.log(chalk.yellow(`\nåˆ é™¤ç›®å½• ${projectName}...`));
        fs.rmSync(targetDir, { recursive: true, force: true });
      }
    }
  }

  // æ”¶é›†é¡¹ç›®ä¿¡æ¯
  const answers = await collectProjectInfo(projectName, options);
  
  // åˆ›å»ºé¡¹ç›®ç›®å½•
  fs.mkdirSync(targetDir);
  
  console.log(chalk.cyan('\nå¼€å§‹åˆ›å»ºé¡¹ç›®...'));
  
  try {
    // ä¸‹è½½æ¨¡æ¿
    const templateDir = await downloadTemplate(answers.template);
    
    // ç”Ÿæˆé¡¹ç›®æ–‡ä»¶
    await generator.generate(projectName, templateDir, answers);
    
    // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
    showSuccessMessage(projectName, answers);
    
  } catch (error) {
    console.error(chalk.red('åˆ›å»ºé¡¹ç›®å¤±è´¥:'), error);
    // æ¸…ç†å¤±è´¥çš„é¡¹ç›®ç›®å½•
    if (fs.existsSync(targetDir)) {
      fs.rmSync(targetDir, { recursive: true });
    }
    process.exit(1);
  }
}

// æ”¶é›†é¡¹ç›®ä¿¡æ¯
async function collectProjectInfo(projectName, options) {
  const questions = [];
  
  // å¦‚æœæ²¡æœ‰æŒ‡å®šæ¨¡æ¿ï¼Œè¯¢é—®ç”¨æˆ·
  if (!options.template) {
    questions.push({
      type: 'list',
      name: 'template',
      message: 'è¯·é€‰æ‹©é¡¹ç›®æ¨¡æ¿:',
      choices: [
        { name: 'Vue é¡¹ç›®', value: 'vue' },
        { name: 'React é¡¹ç›®', value: 'react' },
        { name: 'Node.js é¡¹ç›®', value: 'node' }
      ]
    });
  }
  
  // å…¬å…±é—®é¢˜
  questions.push(
    {
      type: 'input',
      name: 'description',
      message: 'é¡¹ç›®æè¿°:',
      default: `A ${options.template || 'new'} project`
    },
    {
      type: 'input',
      name: 'author',
      message: 'ä½œè€…:',
      default: process.env.USER || 'anonymous'
    },
    {
      type: 'list',
      name: 'packageManager',
      message: 'é€‰æ‹©åŒ…ç®¡ç†å™¨:',
      choices: [
        { name: 'npm', value: 'npm' },
        { name: 'yarn', value: 'yarn' },
        { name: 'pnpm', value: 'pnpm' }
      ]
    }
  );
  
  const answers = await inquirer.prompt(questions);
  
  // åˆå¹¶é€‰é¡¹
  return {
    projectName,
    template: options.template || answers.template,
    description: answers.description,
    author: answers.author,
    packageManager: answers.packageManager,
    version: '1.0.0'
  };
}

// ä¸‹è½½æ¨¡æ¿
async function downloadTemplate(templateName) {
  const templateMap = {
    vue: 'direct:https://github.com/vuejs-templates/webpack-simple.git',
    react: 'direct:https://github.com/facebook/create-react-app.git',
    node: 'local:node-template' // ä½¿ç”¨æœ¬åœ°æ¨¡æ¿
  };
  
  const templateUrl = templateMap[templateName];
  
  if (!templateUrl) {
    throw new Error(`ä¸æ”¯æŒçš„æ¨¡æ¿: ${templateName}`);
  }
  
  return await download(templateUrl, templateName);
}

// æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
function showSuccessMessage(projectName, answers) {
  console.log(chalk.green(`\nâœ… é¡¹ç›® ${projectName} åˆ›å»ºæˆåŠŸï¼\n`));
  console.log(chalk.white('æ¥ä¸‹æ¥æ‰§è¡Œ:'));
  console.log(chalk.cyan(`  cd ${projectName}`));
  console.log(chalk.cyan(`  ${answers.packageManager} install`));
  console.log(chalk.cyan(`  ${answers.packageManager} run dev\n`));
  
  console.log(chalk.white('Happy coding! ğŸ‰'));
}

module.exports = create;
```

### 3.3 æ¨¡æ¿ä¸‹è½½é€»è¾‘ (lib/download.js)

```javascript
const fs = require('fs');
const path = require('path');
const os = require('os');
const download = require('download-git-repo');
const chalk = require('chalk');

/**
 * ä¸‹è½½æ¨¡æ¿
 * @param {string} repo ä»“åº“åœ°å€
 * @param {string} templateName æ¨¡æ¿åç§°
 * @returns {Promise<string>} æ¨¡æ¿ç›®å½•è·¯å¾„
 */
function downloadTemplate(repo, templateName) {
  return new Promise((resolve, reject) => {
    // ä¸´æ—¶ç›®å½•
    const tmpdir = path.join(os.tmpdir(), 'my-cli-templates');
    const templateDir = path.join(tmpdir, templateName);
    
    // å¦‚æœæ˜¯æœ¬åœ°æ¨¡æ¿
    if (repo.startsWith('local:')) {
      const localTemplateName = repo.replace('local:', '');
      const localTemplateDir = path.join(__dirname, '../templates', localTemplateName);
      
      if (!fs.existsSync(localTemplateDir)) {
        reject(new Error(`æœ¬åœ°æ¨¡æ¿ä¸å­˜åœ¨: ${localTemplateName}`));
        return;
      }
      
      console.log(chalk.cyan(`ä½¿ç”¨æœ¬åœ°æ¨¡æ¿: ${localTemplateName}`));
      resolve(localTemplateDir);
      return;
    }
    
    // ä¸‹è½½è¿œç¨‹æ¨¡æ¿
    console.log(chalk.cyan(`ä¸‹è½½æ¨¡æ¿: ${templateName}`));
    
    download(repo, templateDir, { clone: true }, (err) => {
      if (err) {
        reject(err);
        return;
      }
      
      console.log(chalk.green('âœ… æ¨¡æ¿ä¸‹è½½æˆåŠŸ'));
      resolve(templateDir);
    });
  });
}

module.exports = downloadTemplate;
```

### 3.4 æ–‡ä»¶ç”Ÿæˆå™¨ (lib/generator.js)

```javascript
const fs = require('fs');
const path = require('path');
const ejs = require('ejs');
const chalk = require('chalk');

class Generator {
  /**
   * ç”Ÿæˆé¡¹ç›®æ–‡ä»¶
   * @param {string} projectName é¡¹ç›®åç§°
   * @param {string} templateDir æ¨¡æ¿ç›®å½•
   * @param {object} answers ç”¨æˆ·ç­”æ¡ˆ
   */
  async generate(projectName, templateDir, answers) {
    const targetDir = path.join(process.cwd(), projectName);
    
    // è¯»å–æ¨¡æ¿æ–‡ä»¶
    const files = this.readTemplateFiles(templateDir);
    
    console.log(chalk.cyan('ç”Ÿæˆé¡¹ç›®æ–‡ä»¶...'));
    
    // å¤„ç†æ¯ä¸ªæ–‡ä»¶
    for (const file of files) {
      await this.processFile(file, templateDir, targetDir, answers);
    }
    
    // ç”Ÿæˆ package.json
    await this.generatePackageJson(targetDir, answers);
  }
  
  /**
   * è¯»å–æ¨¡æ¿ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
   */
  readTemplateFiles(templateDir) {
    const files = [];
    
    function traverse(dir) {
      const items = fs.readdirSync(dir);
      
      for (const item of items) {
        const fullPath = path.join(dir, item);
        const stat = fs.statSync(fullPath);
        
        // å¿½ç•¥ node_modules å’Œ .git ç›®å½•
        if (item === 'node_modules' || item === '.git') {
          continue;
        }
        
        if (stat.isDirectory()) {
          traverse(fullPath);
        } else {
          files.push(fullPath);
        }
      }
    }
    
    traverse(templateDir);
    return files;
  }
  
  /**
   * å¤„ç†å•ä¸ªæ–‡ä»¶
   */
  async processFile(filePath, templateDir, targetDir, data) {
    // è®¡ç®—ç›¸å¯¹è·¯å¾„
    const relativePath = path.relative(templateDir, filePath);
    const targetPath = path.join(targetDir, relativePath);
    
    // ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
    const targetDirname = path.dirname(targetPath);
    if (!fs.existsSync(targetDirname)) {
      fs.mkdirSync(targetDirname, { recursive: true });
    }
    
    // è¯»å–æ–‡ä»¶å†…å®¹
    let content = fs.readFileSync(filePath, 'utf8');
    
    // å¦‚æœæ˜¯ EJS æ¨¡æ¿ï¼Œè¿›è¡Œæ¸²æŸ“
    if (path.extname(filePath) === '.ejs') {
      const realTargetPath = targetPath.replace(/\.ejs$/, '');
      try {
        content = await ejs.render(content, data, {
          async: true
        });
        fs.writeFileSync(realTargetPath, content, 'utf8');
        console.log(chalk.green('  create ') + relativePath.replace(/\.ejs$/, ''));
      } catch (error) {
        console.log(chalk.red('  error  ') + relativePath);
        throw error;
      }
    } else {
      // ç›´æ¥å¤åˆ¶æ–‡ä»¶
      fs.writeFileSync(targetPath, content, 'utf8');
      console.log(chalk.green('  create ') + relativePath);
    }
  }
  
  /**
   * ç”Ÿæˆ package.json
   */
  async generatePackageJson(targetDir, answers) {
    const packageJsonPath = path.join(targetDir, 'package.json');
    
    let packageJson = {
      name: answers.projectName,
      version: answers.version,
      description: answers.description,
      author: answers.author,
      scripts: {},
      dependencies: {},
      devDependencies: {}
    };
    
    // æ ¹æ®æ¨¡æ¿ç±»å‹æ·»åŠ ä¸åŒçš„é…ç½®
    switch (answers.template) {
      case 'vue':
        packageJson = {
          ...packageJson,
          main: "src/main.js",
          scripts: {
            "dev": "webpack-dev-server --inline --progress --config build/webpack.dev.conf.js",
            "build": "node build/build.js"
          },
          dependencies: {
            "vue": "^2.6.14"
          },
          devDependencies: {
            "webpack": "^4.46.0",
            "webpack-dev-server": "^3.11.3"
          }
        };
        break;
        
      case 'react':
        packageJson = {
          ...packageJson,
          main: "src/index.js",
          scripts: {
            "dev": "react-scripts start",
            "build": "react-scripts build",
            "test": "react-scripts test"
          },
          dependencies: {
            "react": "^17.0.2",
            "react-dom": "^17.0.2"
          },
          devDependencies: {
            "react-scripts": "4.0.3"
          }
        };
        break;
        
      case 'node':
        packageJson = {
          ...packageJson,
          main: "index.js",
          scripts: {
            "start": "node index.js",
            "dev": "nodemon index.js"
          },
          dependencies: {},
          devDependencies: {
            "nodemon": "^2.0.15"
          }
        };
        break;
    }
    
    fs.writeFileSync(
      packageJsonPath, 
      JSON.stringify(packageJson, null, 2), 
      'utf8'
    );
    
    console.log(chalk.green('  create ') + 'package.json');
  }
}

module.exports = new Generator();
```

---

## 4. æœ¬åœ°æ¨¡æ¿ç¤ºä¾‹

### 4.1 Node.js æ¨¡æ¿ (templates/node-template/)

**package.json.ejs:**
```json
{
  "name": "<%= projectName %>",
  "version": "<%= version %>",
  "description": "<%= description %>",
  "main": "index.js",
  "scripts": {
    "start": "node index.js",
    "dev": "nodemon index.js"
  },
  "author": "<%= author %>",
  "license": "MIT"
}
```

**index.js:**
```javascript
const http = require('http');

const server = http.createServer((req, res) => {
  res.writeHead(200, { 'Content-Type': 'text/plain' });
  res.end('Hello from <%= projectName %>!\n');
});

const PORT = process.env.PORT || 3000;
server.listen(PORT, () => {
  console.log(`Server running at http://localhost:${PORT}/`);
});
```

**README.md.ejs:**
```markdown
# <%= projectName %>

<%= description %>

## å¼€å‘

```bash
npm run dev
```

## ç”Ÿäº§

```bash
npm start
```
```

---

## 5. ä¾èµ–å®‰è£…å’Œå‘å¸ƒ

### 5.1 å®‰è£…ä¾èµ–

```bash
npm init -y
npm install commander inquirer chalk download-git-repo ejs
```

### 5.2 å®Œæ•´çš„ package.json

```json
{
  "name": "my-cli",
  "version": "1.0.0",
  "description": "ä¸€ä¸ªç®€å•çš„é¡¹ç›®è„šæ‰‹æ¶",
  "main": "lib/index.js",
  "bin": {
    "my-cli": "./bin/cli.js"
  },
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": ["cli", "scaffold"],
  "author": "Your Name",
  "license": "MIT",
  "dependencies": {
    "chalk": "^4.1.2",
    "commander": "^8.3.0",
    "download-git-repo": "^3.0.2",
    "ejs": "^3.1.6",
    "inquirer": "^8.2.0"
  },
  "files": [
    "bin",
    "lib",
    "templates"
  ]
}
```

### 5.3 æœ¬åœ°æµ‹è¯•

```bash
# å…¨å±€é“¾æ¥è¿›è¡Œæµ‹è¯•
npm link

# æµ‹è¯•å‘½ä»¤
my-cli create my-project
my-cli create my-vue-project --template vue
my-cli create my-react-project --template react --force
```

### 5.4 å‘å¸ƒåˆ° npm

```bash
# ç™»å½• npm
npm login

# å‘å¸ƒ
npm publish

# ç”¨æˆ·å®‰è£…ä½¿ç”¨
npm install -g my-cli
my-cli create my-app
```

---

## 6. åŠŸèƒ½æ‰©å±•

### 6.1 æ·»åŠ æ›´å¤šæ¨¡æ¿é€‰é¡¹

```javascript
// åœ¨ create.js ä¸­æ‰©å±•æ¨¡æ¿é€‰æ‹©
const templateChoices = [
  { name: 'Vue 2 + Webpack', value: 'vue2' },
  { name: 'Vue 3 + Vite', value: 'vue3' },
  { name: 'React + Webpack', value: 'react' },
  { name: 'React + Vite', value: 'react-vite' },
  { name: 'Node.js Express', value: 'node-express' },
  { name: 'TypeScript Library', value: 'ts-lib' }
];
```

### 6.2 æ·»åŠ è‡ªåŠ¨å®‰è£…ä¾èµ–åŠŸèƒ½

```javascript
// åœ¨ create.js çš„ showSuccessMessage åæ·»åŠ 
const { spawn } = require('child_process');

async function autoInstall(projectName, packageManager) {
  console.log(chalk.cyan('\næ­£åœ¨å®‰è£…ä¾èµ–...'));
  
  return new Promise((resolve, reject) => {
    const child = spawn(packageManager, ['install'], {
      cwd: path.join(process.cwd(), projectName),
      stdio: 'inherit'
    });
    
    child.on('close', (code) => {
      if (code === 0) {
        resolve();
      } else {
        reject(new Error(`å®‰è£…å¤±è´¥ï¼Œé€€å‡ºç : ${code}`));
      }
    });
  });
}
```

### 6.3 æ·»åŠ  Git åˆå§‹åŒ–

```javascript
// æ·»åŠ  Git åˆå§‹åŒ–åŠŸèƒ½
const { execSync } = require('child_process');

function initGit(projectDir) {
  try {
    execSync('git init', { cwd: projectDir, stdio: 'ignore' });
    execSync('git add .', { cwd: projectDir, stdio: 'ignore' });
    execSync('git commit -m "Initial commit"', { cwd: projectDir, stdio: 'ignore' });
    console.log(chalk.green('âœ… Git ä»“åº“åˆå§‹åŒ–å®Œæˆ'));
  } catch (error) {
    console.log(chalk.yellow('âš ï¸  Git åˆå§‹åŒ–è·³è¿‡'));
  }
}
```

---

## 7. æ€»ç»“

è¿™ä¸ªç®€å•çš„è„šæ‰‹æ¶å®ç°äº†ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

1. **å‘½ä»¤è¡Œäº¤äº’**ï¼šä½¿ç”¨ commander å’Œ inquirer
2. **æ¨¡æ¿ç®¡ç†**ï¼šæ”¯æŒæœ¬åœ°å’Œè¿œç¨‹æ¨¡æ¿
3. **æ–‡ä»¶ç”Ÿæˆ**ï¼šä½¿ç”¨ EJS æ¨¡æ¿å¼•æ“æ¸²æŸ“æ–‡ä»¶
4. **ç”¨æˆ·é…ç½®**ï¼šæ”¶é›†é¡¹ç›®ä¿¡æ¯å¹¶åº”ç”¨åˆ°æ¨¡æ¿ä¸­
5. **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º

**è¿›ä¸€æ­¥ä¼˜åŒ–æ–¹å‘ï¼š**
- æ·»åŠ æ›´å¤šæ¨¡æ¿é€‰é¡¹
- æ”¯æŒæ’ä»¶ç³»ç»Ÿ
- æ·»åŠ è‡ªåŠ¨ä¾èµ–å®‰è£…
- é›†æˆä»£ç æ£€æŸ¥å·¥å…·
- æ·»åŠ æ›´æ–°æ£€æŸ¥åŠŸèƒ½
